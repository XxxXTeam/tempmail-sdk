name: 发布

on:
  push:
    tags:
      - 'v*'

jobs:
  # 构建验证
  verify:
    name: 构建验证
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 设置 Go 环境
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Go 构建验证
        working-directory: sdk/go
        run: |
          go vet ./...
          go build ./...
      
      - name: npm 构建验证
        working-directory: sdk/npm
        run: |
          npm install
          npx tsc --noEmit
          npm run build

  # 发布 npm 包
  publish-npm:
    name: 发布 npm 包
    runs-on: ubuntu-latest
    needs: [verify]
    defaults:
      run:
        working-directory: sdk/npm
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      - name: 获取版本号
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: 更新 package.json 版本
        run: npm version ${{ steps.version.outputs.VERSION }} --no-git-tag-version --allow-same-version
      
      - name: 安装依赖
        run: npm install
      
      - name: 构建
        run: npm run build
      
      - name: 发布到 npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # 创建 GitHub Release
  create-release:
    name: 创建 GitHub Release
    runs-on: ubuntu-latest
    needs: [publish-npm]
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 获取版本号
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: 生成变更日志
        id: changelog
        run: |
          # 获取上一个 tag
          PREV_TAG=$(git tag --sort=-version:refname | head -n 2 | tail -n 1)
          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "${{ steps.version.outputs.VERSION }}" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          
          # 生成 commit 日志
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          git log ${PREV_TAG}..${{ steps.version.outputs.VERSION }} --pretty=format:"- %s (%h)" --no-merges 2>/dev/null || echo "- 初始发布"
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: 创建 Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## 临时邮箱 SDK ${{ steps.version.outputs.VERSION }}
            
            ### 变更内容
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ### 安装
            
            **npm:**
            ```bash
            npm install tempmail-sdk@${{ steps.version.outputs.VERSION }}
            ```
            
            **Go:**
            ```bash
            go get github.com/XxxXTeam/tempmail-sdk/sdk/go@${{ steps.version.outputs.VERSION }}
            ```
            
            ### 支持的渠道（9 个）
            
            | 渠道 | 服务商 |
            |------|--------|
            | `tempmail` | tempmail.ing |
            | `linshi-email` | linshi-email.com |
            | `tempmail-lol` | tempmail.lol |
            | `chatgpt-org-uk` | mail.chatgpt.org.uk |
            | `tempmail-la` | tempmail.la |
            | `temp-mail-io` | temp-mail.io |
            | `awamail` | awamail.com |
            | `mail-tm` | mail.tm |
            | `dropmail` | dropmail.me |
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
